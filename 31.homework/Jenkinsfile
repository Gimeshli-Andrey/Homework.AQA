pipeline {
    agent any

    environment {
        PROJECT_DIR = '31.homework'
        VENV_NAME = 'venv'
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Клонирование кода из репозитория..."
                git branch: 'main', url: 'https://github.com/Gimeshli-Andrey/Homework.AQA.git'
            }
        }

        stage('Install dependencies') {
            steps {
                sh '''#!/bin/bash
                    echo "Обновление пакетов и установка зависимостей..."
                    apt-get update
                    apt-get install -y python3 python3-dev python3-pip python3.11-venv
                    rm -rf ${PROJECT_DIR}/venv
                    echo "Создание виртуального окружения..."
                    python3 -m venv ${PROJECT_DIR}/venv
                '''
            }
        }

        stage('Install requirements') {
            steps {
                sh '''#!/bin/bash
                    if [ ! -d "${PROJECT_DIR}/venv" ]; then
                        echo "Ошибка: виртуальное окружение не найдено!"
                        exit 1
                    fi
                    echo "Активируем виртуальное окружение..."
                    source ${PROJECT_DIR}/venv/bin/activate

                    echo "Текущий Python: $(which python)"
                    echo "Версия Python: $(python --version)"

                    echo "Устанавливаем зависимости из requirements.txt..."
                    pip install --no-cache-dir -r ${PROJECT_DIR}/requirements.txt

                    # Устанавливаем Faker
                    pip install Faker

                    # Устанавливаем pytz
                    pip install pytz
                '''
            }
        }

        stage('Run tests') {
            steps {
                sh '''#!/bin/bash
                    echo "Проверка содержимого каталога tests..."
                    if [ -d "${PROJECT_DIR}/tests" ]; then
                        ls -l ${PROJECT_DIR}/tests/
                    else
                        echo "Каталог tests не найден"
                        exit 1
                    fi

                    echo "Текущий каталог: $(pwd)"
                    echo "Активируем виртуальное окружение..."
                    source ${PROJECT_DIR}/venv/bin/activate

                    echo "Текущий Python: $(which python)"
                    echo "Версия Python: $(python --version)"

                    echo "Запуск тестов..."
                    pytest ${PROJECT_DIR}/tests/test_app.py --alluredir=${PROJECT_DIR}/allure-results || exit 1
                '''
            }
        }
    }

    post {
        always {
            echo "Публикуем результаты тестов и отчет Allure..."
            allure includeProperties: false, jdk: '', results: [[path: "${env.PROJECT_DIR}/allure-results"]]
        }
        success {
            echo "Пайплайн завершен успешно."
        }
        failure {
            echo "Пайплайн завершен с ошибкой."
        }
    }
}