pipeline {
    agent {
        docker {
            image 'python:3.9' // Используйте образ Python, который вам нужен
            args '-u root' // Добавьте аргументы, если нужно
        }
    }

    stages {
        stage('Checkout') {
            steps {
                // Извлечение кода из репозитория
                git 'https://github.com/Gimeshli-Andrey/Homework.AQA.git' // Замените на URL вашего репозитория
            }
        }

        stage('Install Dependencies') {
            steps {
                // Установка зависимостей проекта
                sh 'pip install -r requirements.txt'
            }
        }

        stage('Run Tests') {
            steps {
                // Запуск тестов в контейнере
                sh 'pytest --alluredir=allure-results'
            }
        }

        stage('Publish Test Results') {
            steps {
                // Сбор результатов тестирования и их публикация в Jenkins
                allure([
                    results: [[path: 'allure-results']],
                    report: 'allure-report'
                ])
            }
        }
    }

    post {
        success {
            // Отправка уведомления на email в случае успешной сборки
            mail to: 'gimeshli.a@gmail.com',
                 subject: "Build Successful: $JOB_NAME - Build # $BUILD_NUMBER",
                 body: "The build was successful! View the results at $BUILD_URL"
        }

        failure {
            // Отправка уведомления на email в случае неудачной сборки
            mail to: 'gimeshli.a@gmail.com',
                 subject: "Build Failed: $JOB_NAME - Build # $BUILD_NUMBER",
                 body: "The build failed. Check the console output at $BUILD_URL for more details."
        }

        unstable {
            // Отправка уведомления на email в случае нестабильной сборки
            mail to: 'gimeshli.a@gmail.com',
                 subject: "Build Unstable: $JOB_NAME - Build # $BUILD_NUMBER",
                 body: "The build is unstable. Check the console output at $BUILD_URL for more details."
        }
    }
}
